Description: restore irqs when putting a character because __put_user might sleep (thanks sven)
Origin: upstream, http://open-mesh.net/changeset/1242
Author: Simon Wunderlich <siwu@hrz.tu-chemnitz.de>
---
 log.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/log.c b/log.c
index 400dbce..3892e31 100644
--- a/log.c
+++ b/log.c
@@ -148,14 +148,15 @@ ssize_t log_read(struct file *file, char __user *buf, size_t count, loff_t *ppos
 
 		log_start++;
 
-		spin_unlock(&logbuf_lock);
+		spin_unlock_irqrestore(&logbuf_lock, flags);
 
 		error = __put_user(c,buf);
 
+		spin_lock_irqsave(&logbuf_lock, flags);
+
 		buf++;
 		i++;
 
-		spin_lock(&logbuf_lock);
 	}
 
 	spin_unlock_irqrestore(&logbuf_lock, flags);
-- 
1.6.2.1

